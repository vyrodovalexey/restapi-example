# Docker Compose test environment for mTLS and OIDC authentication testing.
# Provides Vault (PKI), Keycloak (OIDC), PostgreSQL, and init services.
# The REST API server is run separately for testing.

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL – backing store for Keycloak
  # ---------------------------------------------------------------------------
  keycloakdb:
    image: postgres:16
    container_name: keycloakdb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 5s
      timeout: 3s
      retries: 10

  # ---------------------------------------------------------------------------
  # Keycloak – OIDC identity provider
  # ---------------------------------------------------------------------------
  keycloak_web:
    image: quay.io/keycloak/keycloak:26.5
    container_name: keycloak_web
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloakdb:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password

      KC_HTTP_PORT: 8090
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      KC_FEATURES: token-exchange,admin-fine-grained-authz
      KC_SPI_REALM_DEFAULT_SSL_REQUIRED: none

      KC_LOG_LEVEL: info
      KC_METRICS_ENABLED: true
      KC_HEALTH_ENABLED: true
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    command: start-dev --import-realm
    volumes:
      - ./config/keycloak-realm.json:/opt/keycloak/data/import/restapi-test-realm.json:ro
    depends_on:
      keycloakdb:
        condition: service_healthy
    ports:
      - "8090:8090"
      - "8091:9000"
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/9000"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Vault – PKI secrets engine for mTLS certificates
  # ---------------------------------------------------------------------------
  vault:
    image: hashicorp/vault:1.17
    container_name: vault
    volumes:
      - vault_data:/vault/file
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: myroot
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://127.0.0.1:8200
    cap_add:
      - IPC_LOCK
    ports:
      - "8200:8200"
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 5s
      timeout: 3s
      retries: 15
      start_period: 5s

  # ---------------------------------------------------------------------------
  # vault-init – Initialise Vault PKI and generate certificates
  # ---------------------------------------------------------------------------
  vault-init:
    image: hashicorp/vault:1.17
    container_name: vault-init
    volumes:
      - ./scripts/init-vault.sh:/scripts/init-vault.sh:ro
      - certs:/certs
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: myroot
      CERTS_DIR: /certs
    entrypoint: ["sh", "/scripts/init-vault.sh"]
    depends_on:
      vault:
        condition: service_healthy
    restart: "no"

  # ---------------------------------------------------------------------------
  # keycloak-init – Verify/create Keycloak realm, client and users
  # ---------------------------------------------------------------------------
  keycloak-init:
    image: hashicorp/vault:1.17
    container_name: keycloak-init
    volumes:
      - ./scripts/init-keycloak.sh:/scripts/init-keycloak.sh:ro
    environment:
      KEYCLOAK_URL: http://keycloak_web:8090
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      REALM_NAME: restapi-test
      CLIENT_ID: restapi-server
      CLIENT_SECRET: restapi-server-secret
    entrypoint: ["sh", "/scripts/init-keycloak.sh"]
    depends_on:
      keycloak_web:
        condition: service_healthy
    restart: "no"

volumes:
  postgres_data:
  vault_data:
  certs:
